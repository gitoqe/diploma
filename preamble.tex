\usepackage{fontspec}       % XeTeX
\usepackage{xunicode}       % Unicode в XeTeX
\usepackage{xltxtra}        % индексы
\usepackage{pdfpages}       % Вставка PDF
\usepackage{comment}        % комментарии внутри tex файлов

\usepackage{titletoc,tocloft}
\usepackage{listings} % Оформление исходного кода
% http://users.ece.utexas.edu/~garg/dist/listings.pdf
\lstset{
    keywordstyle=\color{black}\bfseries\underbar,
% underlined bold black keywords
    basicstyle=\small\ttfamily, % Размер и тип шрифта
    breaklines=true, % Перенос строк
    tabsize=2, % Размер табуляции
    literate={--}{{-{}-}}2, % Корректно отображать двойной дефис
    stringstyle=\ttfamily, % typewriter type for strings
    showstringspaces=true,
    numbers=left,
    %numberstyle=\tiny,
    %stepnumber=5,
    numbersep=5pt
}

% JS highlighting
% https://tex.stackexchange.com/questions/89574/language-option-supported-in-listings
\lstdefinelanguage{JavaScript}{
  keywords={break, case, catch, continue, debugger, default, delete, do, else, false, finally, for, function, if, in, instanceof, new, null, return, switch, this, throw, true, try, typeof, var, void, while, with},
  morecomment=[l]{//},
  morecomment=[s]{/*}{*/},
  morestring=[b]',
  morestring=[b]",
  ndkeywords={class, export, boolean, throw, implements, import, this},
  keywordstyle=\color{blue}\bfseries,
  ndkeywordstyle=\color{darkgray}\bfseries,
  identifierstyle=\color{black},
  commentstyle=\color{purple}\ttfamily,
  stringstyle=\color{red}\ttfamily,
  sensitive=true
}

% Шрифты, xelatex
\defaultfontfeatures{Ligatures=TeX}
\setmainfont{Times New Roman} % текст
\newfontfamily\cyrillicfont{Times New Roman}
\newfontfamily{\cyrillicfonttt}{FreeMono}
\setmonofont{FreeMono}      % код

% Русский язык
\usepackage{polyglossia}
\setdefaultlanguage{russian}

% Математические формулы
\usepackage{amssymb,amsfonts,amsmath}
\numberwithin{equation}{section} % Формула вида секция.номер


\usepackage{enumerate}      % Тонкая настройка списков
\usepackage{indentfirst}    % Красная строка после заголовка
\usepackage{float}          % Расширенное управление плавающими объектами
\usepackage{multirow}       % Сложные таблицы


% Изображения
\usepackage{graphicx}
\graphicspath{images/}      % расположение изображений


% Подписи к рисункам
\usepackage{chngcntr}
\counterwithin{figure}{section}


% Оформление гиперссылок
\usepackage{hyperref}
\hypersetup{
    colorlinks,
    urlcolor={black},
    linkcolor={black},
    citecolor={black},
    filecolor={black},
    % urlcolor={red},
    % linkcolor={blue},
    % citecolor={green},
    % filecolor={orange},
    pdfauthor={Максим Сергиенко},
    pdftitle={Разработка Web-ресурса для учебного центра «Мезон»}
}


% Оформление библиографии и подрисуночных записей через точку
\makeatletter
\renewcommand*{\@biblabel}[1]{\hfill#1.}
\renewcommand*\l@section{\@dottedtocline{1}{1em}{1em}}
\renewcommand{\thefigure}{\thesection.\arabic{figure}} % Формат рисунка секция.номер
\renewcommand{\thetable}{\thesection.\arabic{table}} % Формат таблицы секция.номер
\def\redeflsection{\def\l@section{\@dottedtocline{1}{0em}{10em}}}
\makeatother


% Интервал, отступы
\renewcommand{\baselinestretch}{1.5} % Полуторный межстрочный интервал
\parindent 1.0cm % Абзацный отступ


\sloppy                     % Избавляемся от переполнений
\hyphenpenalty=1000         % Частота переносов
\clubpenalty=10000          % Запрещаем разрыв страницы после первой строки абзаца
\widowpenalty=10000         % Запрещаем разрыв страницы после последней строки абзаца


% Поля страниц
\usepackage{geometry}
\geometry{left=3cm}
\geometry{right=1cm}
\geometry{top=2cm}
\geometry{bottom=2cm}


% Оформление списка
\usepackage{enumitem}
\setlist[enumerate,itemize]{leftmargin=10mm} % Отступы в списках

\makeatletter
    \AddEnumerateCounter{\asbuk}{\@asbuk}{м)}
\makeatother
\setlist{nolistsep} % Нет отступов между пунктами списка
\renewcommand{\labelitemi}{--} % Маркер списка --
\renewcommand{\labelenumi}{\asbuk{enumi})} % Список второго уровня
\renewcommand{\labelenumii}{\arabic{enumii})} % Список третьего уровня


% Оформление содержания
\usepackage{tocloft}
\renewcommand{\cfttoctitlefont}{\hspace{0.38\textwidth}\MakeTextUppercase} % СОДЕРЖАНИЕ
\renewcommand{\cftsecfont}{\hspace{0pt}}            % Имена секций в содержании не жирным шрифтом
\renewcommand\cftsecleader{\cftdotfill{\cftdotsep}} % Точки для секций в содержании
\renewcommand\cftsecpagefont{\mdseries}             % Номера страниц не жирные
\setcounter{tocdepth}{3}                            % Глубина оглавления, до subsubsection


\begin{comment}
% Оформление нумерации страниц справа-вверху
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[R]{\textrm{\thepage}}
\fancyheadoffset{0mm}
\fancyfootoffset{0mm}
\setlength{\headheight}{17pt}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\fancypagestyle{plain}{ 
    \fancyhf{}
    \rhead{\thepage}
}
\end{comment}



% Формат подрисуночных надписей
\RequirePackage{caption}
\DeclareCaptionLabelSeparator{defffis}{ -- } % Разделитель
\captionsetup[figure]{justification=centering, labelsep=defffis, format=plain} % Подпись рисунка по центру
\captionsetup[table]{justification=raggedright, labelsep=defffis, format=plain, singlelinecheck=false} % Подпись таблицы слева
\addto\captionsrussian{\renewcommand{\figurename}{Рисунок}} % Имя фигуры
\captionsetup[lstinputlisting]{justification=centering, labelsep=defffis, format=plain}

% Пользовательские функции -----------------------------------------------------

% Добавление одного рисунка
\newcommand{\addimg}[4]{ 
    \begin{figure}
        \centering
        \includegraphics[width=#2\linewidth]{#1}
        \caption{#3} \label{#4}
    \end{figure}
}

% Добавить рисунок непосредственно в это место
\newcommand{\addimghere}[4]{
    \begin{figure}[H]
        \centering
        \includegraphics[width=#2\linewidth]{#1}
        \caption{#3} \label{#4}
    \end{figure}
}

% Вставка двух рисунков
\newcommand{\addtwoimghere}[5]{ 
    \begin{figure}[H]
        \centering
        \includegraphics[width=#2\linewidth]{#1}
        \hfill
        \includegraphics[width=#3\linewidth]{#2}
        \caption{#4} \label{#5}
    \end{figure}
}

\begin{comment}
    % Это костыль для приложения Б
\newcommand{\addimgapp}[2]{ 
    \begin{figure}[H]
        \centering
        \includegraphics[width=1\linewidth]{#1}
        \caption*{#2}
    \end{figure}
}
\end{comment}



% Заголовки секций в оглавлении в верхнем регистре
\usepackage{textcase}
\makeatletter
\let\oldcontentsline\contentsline
\def\contentsline#1#2{
    \expandafter\ifx\csname l@#1\endcsname\l@section
        \expandafter\@firstoftwo
    \else
        \expandafter\@secondoftwo
    \fi
    {\oldcontentsline{#1}{\MakeTextUppercase{#2}}}
    {\oldcontentsline{#1}{#2}}
}
\makeatother


% Оформление заголовков ---------------------------------------------------
\usepackage[compact,explicit]{titlesec}
\titleformat{\section}{\vspace{0pt}}{}{10mm}{\centering{\thesection\quad\MakeTextUppercase{#1}}\vspace{14pt}}

\titleformat{\subsection}[block]{\vspace{14pt}}{}{10mm}{\thesubsection\quad#1\vspace{14pt}}

\titleformat{\subsubsection}[block]{\vspace{14pt}\normalsize}{}{10mm}{\thesubsubsection\quad#1\vspace{14pt}}

\titleformat{\paragraph}[block]{\normalsize}{}{0mm}{\MakeTextUppercase{#1}}

% Отступы внутри заголовков
\setlength{\cftsecindent}{1.0cm}
\setlength{\cftsubsecindent}{0.5cm}
\setlength{\cftsubsubsecindent}{0.5cm}



% Секции без номеров (введение, заключение...), вместо section*{}
\newcommand{\anonsection}[1]{
    \phantomsection % Корректный переход по ссылкам в содержании
    \paragraph{\centerline{{#1}}\vspace{1em}}
    
    \addcontentsline{toc}{section}{\uppercase{#1}}
}


% Секции для приложений
\newcommand{\appsection}[1]{
    \phantomsection
    \paragraph{\centerline{{#1}}}
    \addcontentsline{toc}{section}{\uppercase{#1}}
}

% Библиография: отступы и межстрочный интервал
\makeatletter
\renewenvironment{thebibliography}[1]
    {\section*{\refname}
        \list{\@biblabel{\@arabic\c@enumiv}}
           {\settowidth\labelwidth{\@biblabel{#1}}
            \leftmargin\labelsep
            \itemindent 16.7mm
            \@openbib@code
            \usecounter{enumiv}
            \let\p@enumiv\@empty
            \renewcommand\theenumiv{\@arabic\c@enumiv}
        }
        \setlength{\itemsep}{0pt}
    }
\makeatother

\setcounter{page}{2} % Начало нумерации страниц
