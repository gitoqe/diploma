\section{ПРОЕКТИРОВАНИЕ WEB-РЕСУРСА ДЛЯ УЧЕБНОГО ЦЕНТРА}

На основании технологий и требований, выделенных в главах 1 и 2 можно составить краткий план выполнения практической части работы.
Необходимо обеспечить процесс разработки документацией и планами вносимых изменений.

В первую очередь необходимо подготовить схему планируемой функциональной структуры ресурса.
На основании данной схемы будут строится взаимосвязи между программными решениями, используемыми для разработки и дальнейшей работы сайта.

Далее разрабатывается функциональная модель веб-ресурса, диаграмма вариантов использования, диаграмма деятельности.
Данный шаг позволит лучше понимать состав необходимых для реализации компонентов веб-ресурса.

Следующий этап -- формирование структурной схемы веб-ресурса.
В её задачи будет входить упрощенное описание компонентов-страниц сайта, расположение и отношение между ними.
Этот шаг позволит с пониманием общей картины подходить к разработке отдельных частей ресурса.

Следующим важным решением будет выделение ключевых сущностей для хранения в базе данных, их взаимоотношения и зависимостей.
На основе этих данных будут строится отдельные компоненты страниц веб-ресурса с использованием шаблонов.


\subsection{Функциональная структура ресурса}

Исходя из определенных для использования в главах 1 и 2 программных средств, можно составить функциональную структуру ресурса.
Она призвана отобразить основные элементы системы, обеспечивающие работу элементов сайта, а также взаимосвязи между ними.

Выбранными элементами стека MEAN с внесёнными правками являются -- SQLite в роли СУБД, Express и Node.js для организации серверной части приложения, Angular для работы с клиентской частью.
Также стоит упомянуть CSS-библиотеку Bulma, которая также будет задействована в данной работе.
На основе приведенных программных средств составлена схема функциональных элементов на рисунке \ref{func-struct-scheme}.

\addimghere{images/diagrams/функциональная-структура.png}{0.4}{Функциональная структура веб-ресурса}{func-struct-scheme}


\subsection{Разработка функциональной модели веб-ресурса}

Для построения функциональной модели веб-ресурса можно воспользоваться методологией IDEF0 \cite{wiki-idef0}.
Для этого потребуется сначала оформить контекстную диаграмму проектируемого веб-ресурса, что в свою очередь означает необходимость выделить абстрактное общее описание системы.

Далее можно углубляться в указанные на схеме элементы.
Такой подход позволяет на разных уровнях информационной обеспеченности протекающими процессами поэтапно проанализировать каждый из них с желаемой степенью подробности.

В процессе составления элементов диаграммы могут возникать дополнительные вопросы к частям проектируемого веб-ресурса, что приведет к повышению проработанности как конкретных составляющих, так и системы в целом.

Построенная контекстная диаграмма IDEF0 отображена на рисунке \ref{idef0-drawio}.

\addimghere{images/diagrams/idef0.drawio.png}{0.9}{Контекстная диаграмма  IDEF0}{idef0-drawio}

В методологии IDEF0 организация модулей и их взаимодействие между собой и внешним миром обозначается с помощью стрелок, каждой сопоставляется своя роль.

Входящая информация, используемая блоком получается от стрелки входа, она присоединяется к блоку слева.
Управляющие указания поступают сверху от модуля.
Механизмом или исполнителем является стрелка, примыкающая снизу от блока.
Выход отображается как исходящая из правой кромки модуля стрелка.

Описание стрелок, их типы и характеристики применительно к построенной контекстной диаграмме представлено в таблице \ref{table-context-diagram}.

\begin{small}
\begin{singlespacing}
\begin{longtable}[h]{| p{5.8cm} | p{7.8cm} | c |}
    \caption{Описание элементов контекстной диаграммы}\label{table-context-diagram}\\
    \hline
    \centering Название стрелки&
    \centering Описание&
    Тип\\
    \hline
    \centering 1&
    \centering 2&
    3\\
    \hline\endfirsthead
    \multicolumn{3}{@{}l}{Продолжение таблицы \ref{table-context-diagram}}\\
    \hline
    \centering 1&
    \centering 2&
    3\\
    \endhead

    Пользовательское соглашение&
    Пользовательское соглашение, содержащее условия использования функционала сайта, между клиентом-пользователем портала и администратором-владельцем веб-ресурса&
    Control\\

    \hline
    Администратор сайта&
    Производит сбор, проверку и редактуру входящей информацию в соответствии с требованиями учебного центра&
    Mechanism\\
    \hline
    Web-ресурса&
    Отвечает за формирование и предоставление компонентов веб-ресурса&
    Mechanism\\

    \hline
    Информация о курсах&
    Информация о курсах, предлагаемых учебным центром, их описание и план занятий&
    Input\\
    \hline
    Информация о поступлении&
    Информация о необходимых документах, стоимости обучения и предлагаемых скидках&
    Input\\
    \hline
    Информация о расписании&
    Информация о расписании активных групп учебного центра&
    Input\\
    \hline
    Информация о работах учеников&
    Информация о примерах работ учеников различных курсов&
    Input\\
    \hline
    Информация об организации&
    Информация о коллективе, документация и сведениях об учебном центре&
    Input\\
    \hline
    Информация об оплате и аренде&
    Информация о способах оплаты обучения и предлагаемых услугах аренды помещений&
    Input\\

    \hline
    Компонент с информацией о курсах&
    Информационный блок, содержащий отредактированные и отобранные данные о проводимых курсах, их описании и плане занятий&
    Output\\
    \hline
    Компонент с информацией о поступлении&
    Информационный блок, содержащий отредактированные и отобранные данные о необходимых документах, стоимости обучения и предлагаемых скидках&
    Output\\
    \hline
    Компонент с информацией о расписании&
    Информационный блок, содержащий отредактированные и отобранные данные о расписании активных групп учебного центра&
    Output\\
    \hline
    Компонент с информацией о работах учеников&
    Информационный блок, содержащий отредактированные и отобранные данные о примерах работ учеников различных курсов&
    Output\\
    \hline
    Компонент с информацией об организации&
    Информационный блок, содержащий отредактированные и отобранные данные о коллективе, документации и сведениях об учебном центре&
    Output\\
    \hline
    Компонент с информацией об оплате и аренде&
    Информационный блок, содержащий отредактированные и отобранные данные о способах оплаты обучения и предлагаемых услугах аренды помещений&
    Output\\
    \hline
\end{longtable}
\end{singlespacing}
\end{small}

Следующим этапом формирования функциональной модели деятельности веб-ресурса является более глубокий разбор полученной схемы.
Для этого необходимо провести декомпозицию первого уровня готовой диаграммы IDEF0.
В данном случае необходимо разобрать процесс <<Работа веб-ресурса учебного центра>> на составляющие.

Можно выделить следующие этапы: <<Взаимодействие с преподавательским составом и руководством УЦ>>, <<Внесение изменений в базу данных веб-ресурса УЦ>>, <<Проверка и формирование готовых компонентов веб-ресурса>>.

Результат проведения декомпозиции первого уровня над полученной диаграммой IDEF0 отображен на рисунке \ref{idef0-decompose-1}.

\addimghere{images/diagrams/idef0-decompose-1.drawio.png}{1.0}{Декомпозиция первого уровня исходной диаграммы IDEF0}{idef0-decompose-1}

В полученной схеме можно провести еще один этап декомпозиции -- блок <<Проверка и формирование готовых компонентов веб-ресурса>> состоит из частей <<Проверка связей между базой данных и компонентами>>, <<Внесение изменений в компоненты>> и <<Проверка корректности работы компонента>>.
Результат проведения декомпозиции второго уровня над этим блоком отображен на рисунке \ref{idef0-decompose-2}.

\addimghere{images/diagrams/idef0-decompose-2.drawio.png}{1.0}{Декомпозиция второго уровня исходной диаграммы IDEF0}{idef0-decompose-2}


\subsection{Разработка диаграммы вариантов использования}

Диаграмма вариантов использования поможет отобразить отношения между активными участниками процесса использования веб-ресурса и различными типами взаимодействия.

На основе этих связей можно будет выявить способы решения задач пользователей системы.
На рисунках \ref{variants-user} и \ref{variants} отображены диаграммы вариантов использования для разрабатываемого веб-ресурса применительно к роли администратора и пользователя соответственно.

\addimghere{images/diagrams/variants-user.drawio.png}{0.6}{Диаграмма вариантов использования для пользователя}{variants-user}

\addimghere{images/diagrams/variants.drawio.png}{0.6}{Диаграмма вариантов использования для администратора}{variants}

Возможности администратора ограничены взаимодействием с отображаемым контентом сайта -- редактированием, добавлением и удалением информации в базе данных, а также внесением правок в состав компонентов.
Варианты взаимодействия пользователя описываются стандартным набором вариантов взаимодействия на сайтах.
В этот набор входим просмотр информации, переключение между разделами, использование формы связи и переход на прочие ресурсы учебного центра.


\subsection{Разработка диаграммы деятельности}

В задачи данной диаграммы входит отображение в формате, схожем с блок-схемой алгоритма, различных путей прохождения этапов взаимодействия с веб-ресурсом.

Прямое взаимодействие начинается с загрузки частей веб-ресурса, в которые входят файлы скриптов, гипертекстовой разметки, каскадных таблиц стилей, а также используемые медиа-файлы.
Далее производится отображение загруженного контента в виде главной страницы, которая будет содержать в себе остальные компоненты сайта.
Первоначально в этот контейнер помещается домашняя страница, с которой уже можно перейти на побочные.

Диаграмма деятельности пользователей разрабатываемого портала отображена на рисунке \ref{occupation}.

\addimghere{images/diagrams/occupation.drawio.png}{0.7}{Диаграмма деятельности пользователей разрабатываемого портала}{occupation}

Последующие варианты взаимодействия зависят от потребностей пользователя -- можно как ознакомится с содержимым прочих разделов, а можно воспользоваться адресной строкой браузера для ввода адреса скрытого компонента авторизации.

При переходе на страницу входа администратора отобразится форма для ввода логина и пароля.
После ввода заранее полученных данных производится процесс проверки.
При успешном результате проведения процесса авторизации будет открыт доступ к странице редактирования содержимого компонентов, где можно рассмотреть и внести правки в отображаемый контент.
После завершения взаимодействия с позиции администратора, можно произвести операцию выхода из этого режима.
В случае ввода некорректных данных в форму логина будет выдано сообщение об ошибке с возможностью повторного ввода данных.


\subsection{Анализ структуры исходного ресурса}\label{Анализ структуры исходного ресурса}

Главная страница исходного сайта содержит 4 основных раздела -- <<Главная>>, <<Сведения об организации>>, <<Обучение>>, <<Аренда>>.
Также здесь расположены различные вспомогательные ссылки, реализующие переходы на некоторые ключевые разделы ресурса.
Схема основных переходов внутри главной страницы отображена на рисунке \ref{meson-old-main}.

\addimghere{images/diagrams/главная.png}{1}{Схема строения переходов исходного веб-ресурса}{meson-old-main}

В схеме на рисунке \ref{meson-old-main} отметкой <<(неактуально)>> помечены переходы на неактуальные страницы, которые по разным причинам либо давно не обновлялись, либо отсутствуют вовсе.
При этом основными функциональными элементами на главной странице являются ссылки <<Расписание>>, <<Стоимость>> и <<Брошюра>>.
Взаимодействие с данными, представленными на целевых страницах этих ссылок содержит самую полезную информацию, которая может потребоваться для клиентов учреждения.
Помимо этого, контент этих элементов частично дублируется и частично взаимно противоречит.

Раздел <<Сведения об организации>> содержит наибольшее количество вложенных страниц -- <<Основные сведения>>, <<Документы>>, <<Образование>>, <<Образовательные стандарты>>, <<Руководство и педагогический состав>>, <<Структура и органы управления>>, <<Материально-техническое обеспечение и оснащенность образовательного процесса>>, <<Стипендии и иные виды материальной поддержки>>, <<Платные образовательные услуги>>, <<Финансово-хозяйственная деятельность>>, <<Вакантные места для приема (перевода)>>.
Большая часть содержимого этих подразделов либо дублируется в других частях ресурса, либо является вовсе неактуальной.

Раздел <<Обучение>> состоит из страниц <<Компьютерная школа>>, <<Лаборатории инновационного творчества>>, <<Школа личностного роста>>, <<ИТ-курсы для взрослых>>.
Содержимое этих частей ресурса по большей части устарело и является неактуальным.

Раздел <<Аренда>> содержит информацию об аренде помещений учебного центра.
Часть информации данной страницы является неактуальной.
Подразделы здесь отсутствуют.

Помимо переходов на обозначенные разделы со страницы <<Главная>>, также есть необозначенные там три -- <<Независимая оценка качества>>, <<Противодействие коррупции>>, <<Инклюзивное образование>>.
Состав этих элементов также является частично неактуальным.

Из вышеописанных фактов можно сделать вывод о заброшенности большинства разделов сайта.
Часть этих страниц можно актуализировать и восстановить в новой версии, а часть объединить с другими.


\subsection{Структура проектируемого ресурса}

На основе проведенного в подпункте \ref{Анализ структуры исходного ресурса} анализа можно выделить ключевые разделы проектируемого веб-ресурса с учетом объединения и перестановки исходных.
В результате получатся следующие пункты: <<Поступление>>, <<Курсы>>, <<Расписание>>, <<Работы учеников>>, <<Об организации>>, <<Оплата и аренда>>.

Раздел <<Поступление>> рассказывает пользователю о правилах записи на курсы учебного центра.

Раздел <<Курсы>> представляет клиенту набор имеющихся для проведения курсов обучения с возможностью подробного рассмотрения особенностей каждого из них в отдельности.

Раздел <<Расписание>> включает в себя расписание занятий групп на учебный год, позволяет оперативно сориентировать клиентов касательно выходных дней в организации.

Раздел <<Работы учеников>> представляет клиентам возможность ознакомиться с выставленными работами студентов разных направлений.

Раздел <<Об организации>> содержит информацию о компании, руководстве, а также обширный набор вспомогательной документации, полезной для ознакомления.

Раздел <<Оплата и аренда>> содержит информацию о способах оплаты услуг учебного центра и предоставляемых в аренду помещениях.

Также стоит отметить точку входа на сайт -- раздел <<Главная>>, встречающий пользователя.
Здесь описываются функциональные модули-страницы сайта и их содержимое, а также основные данные об учебном центре.

На основании приведенных разделов можно сформировать структурную схему веб-ресурса, отображающую получившуюся иерархию страниц.
Упрощение базовой структуры облегчит взаимодействие с информацией на сайте.
Также будет проще пользоваться ресурсом на мобильных устройствах.

Результат формирования структуры проектируемого ресурса с учетом указанных выше разделов представлен на рисунке \ref{struct-scheme}.

\addimghere{images/diagrams/структура-ресурса.png}{1}{Структурная схема проектируемого веб-ресурса}{struct-scheme}

\clearpage


\subsection{Выделение основных сущностей и построение полной атрибутивной модели данных}\label{Выделение основных сущностей и построение полной атрибутивной модели данных}

В работе любой системы задействуются данные.
Их можно классифицировать по различным признакам, на основе которых можно выделить общий набор характеристик и хранить их в единообразном хранилище -- базе данных.

Для разрабатываемого ресурса будут задействованы возможности СУБД SQLite.
Важно учитывать особенность данной СУБД -- наличие ограниченного списка базовых типов данных.
В него входят NULL для пустых значений, INTEGER для целочисленных значений разного размера с учетом знака, REAL для хранения вещественных значений, TEXT для хранения строк, BLOB для хранения двоичных объектов.
Среди имеющегося на исходном сайте контента можно выделить несколько сущностей, доступных для переноса в формат базы данных.

Первая таблица -- <<Courses>>.
Предназначен для хранения информации о конкретном курсе.
В общие характеристики-поля можно выделить имя, описание, стоимость, тип оплаты -- за месяц или занятие, прямое продолжение курса, уровень курса -- дошкольный или школьный, класс или возраст в зависимости от уровня курса, длительность занятия, список тем.
Схема данной таблицы представлена на рисунке \ref{uml-courses}.

\addimghere{images/uml/uml-courses.png}{0.3}{Схема таблицы <<Courses>>}{uml-courses}

Вторая таблица -- <<Levels>>
Это вспомогательная таблица содержит поле для выбора в таблице <<Courses>> -- наименование уровня.
Схема данной таблицы представлена на рисунке \ref{uml-levels}.

\addimghere{images/uml/uml-levels.png}{0.3}{Схема таблицы <<Levels>>}{uml-levels}

Третья таблица -- <<Students\_work>>.
Эта таблица будет хранить данные для представления на странице итоговых работ студентов с разных курсов.
Для её работы потребуются следующие поля -- соответствующий курс, опциональное имя студента, год выполнения работы, ссылка на работу.
Схема данной таблицы представлена на рисунке \ref{uml-students_work}.

\addimghere{images/uml/uml-students_work.png}{0.3}{Схема таблицы <<Students\_work>>}{uml-students_work}

Четвертая таблица -- <<Employees>>.
Сюда можно отнести данны о преподавательском составе.
Выделяемые поля -- фамилия, имя, отчество, должность, образование, год начала работы, педагогический стаж.
Схема данной таблицы представлена на рисунке \ref{uml-employees}.

\addimghere{images/uml/uml-employees.png}{0.3}{Схема таблицы <<Employees>>}{uml-employees}

На данном этапе возникает необходимость в перечислении нескольких значений в составе одной ячейки.
Можно выполнить такую задачу через применение связующей таблицы, где будут перечислены соотношения между записями отдельных таблиц.

Пятая таблица -- <<Teaches>>.
Данная таблица -- связующая между таблицами <<Employees>> и <<Courses>>.
В её задачи входит перечисление соответствий сотрудников преподаваемым ими курсам.
Схема данной таблицы представлена на рисунке \ref{uml-teaches}.

\addimghere{images/uml/uml-teaches.png}{0.3}{Схема таблицы <<Teaches>>}{uml-teaches}

Итоговый вид базы данных с таблицами, используемыми в формировании наполнения веб-ресурса представлен на рисунке \ref{uml-final}.

\addimghere{images/uml/uml-final.png}{0.6}{Структура таблиц базы данных, участвующих в формировании содержимого веб-ресурса}{uml-final}

Помимо использования контента, расположенного в базе данных, веб-ресурсу также требуется возможность редактирования исходной информации.
Для таких задач может подойти и обычные программные средства СУБД, так и решения встроенные непосредственно в сайт.

Осуществление данной задачи потребует контроля доступа к функционалу редактирования.
Вместе с этим возникает необходимость хранения данных для его активации.
Для этой задачи можно воспользоваться отдельной таблицей для записи пар логинов и паролей пользователей, обладающих правами редактора содержимого веб-ресурса.

В реализации подходящей таблицы должно быть несколько обязательных полей.
В них входят -- логин пользователя, пароль пользователя, уникальный идентификатор, а также вспомогательный уникальный токен для использования в процессе авторизации.
Схема данной таблицы представлена на рисунке \ref{uml-users}.

\addimghere{images/uml/uml-users.png}{0.3}{Структура таблицы <<Users>>}{uml-users}

На основании представленных схем таблиц базы данных, а также описания полей в них содержащихся, можно сформировать общую картину приложения с точки зрения хранимой информации.
При этом важно учесть сущности, атрибуты и связи.

Указанные в формируемой схеме типы будут соответствовать применяемым в SQLite -- INTEGER, BLOB, TEXT и FLOAT соответственно.
Внешние ключи помечены как сокращение от <<foreign key>> -- <<FK>>, а первичный ключ от <<primary key>> -- <<PK>>.
За данную задачу отвечает полная атрибутивная модель данных, показанная на рисунке \ref{uml-attr-model}.

\addimghere{images/uml/uml-attr-model.png}{0.7}{Полная атрибутивная модель данных проектируемого веб-ресурса}{uml-attr-model}

Исходя из обозначенных в главе 2 задач, а также проведенного анализа и проектирования в данной главе можно переходить к процессу непосредственной разработки элементов веб-ресурса, основываясь на полученных диаграммах, схемах и выводах.


\subsection{Создание и наполнение базы данных}

Для формирования контента разделов веб-ресурса можно воспользоваться отдельными шаблонами для каждой страницы, но в таком случае придется создавать множество однотипных файлов.
Например, количество активно ведущихся курсов больше 20, что вынуждает при применении вышеуказанного подхода задействовать аналогичное количество однообразных документов.
Альтернативный вариант -- использование функционала Angular и применение шаблона страницы, который заполняется переданной в него информацией, извлекаемой из БД.

Для реализации такого подхода были спроектированы схемы таблиц базы данных, применяемых в шаблонах компонентов, касающихся курсов, сотрудников и работ учеников.

Процесс формирования исходного файла базы данных, а также его первоначальное наполнение будет произведено с использованием бесплатной программы SQLiteStudio \cite{sqlitestudio}.
Данное программное обеспечение бесплатно, русифицировано и присутствует на трех основных семействах операционных системы -- Linux, macOS и Windows.
Для работы с базой данных со стороны администратора без необходимости использования веб-интерфейса или серверного решения сайта предполагается использование именно SQLiteStudio.

Пример созданной и заполненной полями с выставленными свойствами таблицы <<Users>> в SQLiteStudio представлен на рисунке \ref{sqlite-users}.

\addimghere{images/sqlite-users.png}{0.8}{Таблица <<Users>> в SQLiteStudio}{sqlite-users}


\subsection{Используемые программные интерфейсы взаимодействия с базой данных}

Для реализации связи между базой данных и приложением нужна программная реализация интерфейса взаимодействия или API.
В случае веб-сервиса предлагается использовать методы протокола HTTP.

Как указывалось в главе 2, одним из наиболее распространенных решений является REST архитектура построения таких механизмов.
Касательно запросов необходимо реализовать CRUD-действия над данными, а именно: Create -- создание, Read -- чтение, Update -- изменение, Delete -- удаление.
Перекладывая их на базу HTTP-методов получается использование стандартных обращений.
Метод GET -- для получения, POST -- для добавления, PUT -- для изменения, DELETE -- для удаления.

Работа такого подхода будет лежать в обращении к серверной стороне по однозначно определенному адресу URL, содержащему конкретное обозначение искомых данных.
Например, часть URL при обращении к пользователю с идентификатором 31 будет выглядеть так: <</users/31>>.

Помимо адреса, для реализации интерфейса важно учитывать и метод протокола HTTP, с которым производится обращение.
Таким образом сочетание <<GET /users/31>> можно интерпретировать за запрос на получение данных о пользователе с идентификатором 31.

Аналогично осуществляется работа и остальных запросов.
Чаще всего вся реализация укладывается в основные 5 запросов, отвечающих за следующие задачи: добавления записи, удаления записи, обновления записи, получения записи, получения всех записей данного типа.

Исходя из описанного, а также выявленных в разделе \ref{Выделение основных сущностей и построение полной атрибутивной модели данных} спецификаций таблиц можно составить требования к проектируемым программным интерфейсам.

Предварительно задачу можно описать так: необходимо реализовать по 5 HTTP-методов для взаимодействия с таблицами <<Levels>>, <<Courses>>, <<Students\_work>>, <<Employees>>, <<Teaches>>, <<Users>>.
При этом важно учитывать, что активное взаимодействие как и полная реализация интерфейсов со стороны веб-приложения потребуется лишь для некоторых таблиц.

Система запросов к программным интерфейсам называется роутингом от английского route -- путь.
Выстраивая такую коллекцию возможных путей мы реализуем доступ по ним извне серверной части веб-сервиса.

Для реализации роутинга на базе Node.js можно использовать как встроенные средства, так и пользоваться библиотеками и фреймворками.
В данной работе будет задействоваться Express.js.
С его помощью будут описаны обращения к различным роутам приложения и завязанные с этим взаимодействия с базой данных.

На рисунке \ref{code-router-get} показана реализация стандартного обращения к серверу без передачи параметров в URL, где при запросе к корневому адресу сервера будет произведен ответ с содержимым <<Server is working>>.

\addimghere{images/code/code-api-get-default-route.png}{0.4}{Реализация роута для GET запроса без параметров}{code-router-get}

Для проверки работы запросов можно воспользоваться Postman \cite{postman}.
Данная программа позволяет создавать и хранить шаблоны обращений к веб-серверам с использованием различных сочетаний запросов и передаваемых данных.
Пример выполнения метода GET к серверу без передачи параметров в URL и теле запроса через Postman представлен на рисунке \ref{postman-get-default}

\addimghere{images/postman-get-default.png}{0.9}{Выполнение GET запроса к серверу с использованием программы Postman}{postman-get-default}

Для реализации взаимодействия с базой данных необходимо воспользоваться библиотекой sqlite3, предоставляемой для Node.js.
Через неё реализуется подключение и обработка команд.
Процесс описания модуля взаимодействия с файлом базы данных sqlite отображен на рисунке \ref{code-api-db-handler}.

\addimghere{images/code/code-api-db-handler.png}{0.8}{Объявление и настройка подключения к файлу базы данных с использованием библиотеки sqlite3}{code-api-db-handler}

Созданный объект взаимодействия экспортируется для осуществления доступа к нему в других файлах веб-сервера.
После этого можно выстраивать запрос к базе с использованием обозначенного подключения.

Примеры построения пяти базовых методов обработки обращения к таблице <<Courses>> через HTTP запросы приведены ниже.
На рисунке \ref{code-api-example-courses-1} -- вариант настройки обработки GET запроса ко всей таблице, а на рисунке \ref{code-api-example-courses-2} -- также обработка GET, но с указанным идентификатором записи

\addimghere{images/code/code-api-example-courses-1.png}{0.7}{Обработка метода GET к таблице <<Courses>>}{code-api-example-courses-1}

\addimghere{images/code/code-api-example-courses-2.png}{0.8}{Обработка метода GET к таблице <<Courses>> с переданным значением идентификатора}{code-api-example-courses-2}

Дальнейшие демонстрации кода также отображают составные элементы реализации разбора обращения.
На рисунке \ref{code-api-example-courses-3} -- обработка POST с передачей параметров, на рисунке \ref{code-api-example-courses-4} -- обработка PUT для конкретной записи с переданными данными,
на рисунке \ref{code-api-example-courses-5} -- обработка DELETE с переданным идентификатором.

\addimghere{images/code/code-api-example-courses-3.png}{1}{Обработка метода POST к таблице <<Courses>> с переданными в теле запроса данными для добавления новой записи}{code-api-example-courses-3}

Для обработки PUT и POST, как видно по представленным рисункам \ref{code-api-example-courses-3} и \ref{code-api-example-courses-4}, требуется дополнительно настроить обработку передаваемых в теле запроса параметров и их передача в запрос непосредственно к базе.

\addimghere{images/code/code-api-example-courses-4.png}{1}{Обработка метода PUT к таблице <<Courses>> с переданным значением идентификатора и новыми данными в теле запроса}{code-api-example-courses-4}

На данном этапе есть возможность добавить проверку передаваемых значений на соответствие типам и другим критериям, выдвигаемым к информации, но можно оставить разрешение данного вопроса на механизмы самой СУБД, что и было выбрано.

\addimghere{images/code/code-api-example-courses-5.png}{0.8}{Обработка метода DELETE к таблице <<Courses>> с переданным значением идентификатора}{code-api-example-courses-5}

Остальные запросы к оставшимся таблицам составляются аналогично с учетом изменения названия таблицы и её полей.
Технически возможно реализовать обращение сразу ко всем имеющимся таблицам через настройку одного метода, но такая реализация требует задействования дополнительных технологий или перехода на другую СУБД.


\subsection{Используемые программные интерфейсы взаимодействия с системой аутентификации}

Отдельно стоит вынести взаимодействие с таблицей <<Users>>, поскольку на нее возлагается ответственность аутентификации пользователя.
Для реализации данной системы потребуется задействовать некоторый способ ограничения доступа к части описанных запросов.

Например, GET методы, относящиеся к таблицам <<Courses>> или <<Students\_work>> относительно безобидны -- их выполнение выдаст информацию, аналогичную содержимому страницы.
Иная ситуация с запросами POST, PUT и DELETE -- их исполнение подразумевает изменение состояния исходных данных, что влияет на работу веб-сервиса.
Потому и необходимо разделение доступа для обычных пользователей и аутентифицированных администраторов сайта, которые могут отредактировать контент прямо в браузере.

Среди большого разнообразия технологий и подходов будет задействован один из простых -- Json Web Token (JWT) \cite{jwt} -- стандарт создания токенов доступа на основе формата JSON \cite{wiki-json}. 
В данной работе принцип взаимодействия с этой технологией будет заключаться в генерации уникального ключа для пользователя при аутентификации, который будет храниться в локальном хранилище браузера пользователя -- localStorage.
С помощью этого ключа будут подписываться запросы к базе данных с целью редактирования.
Без него доступ будет ограничен.

Первоначальная настройка серверной стороны приложения должна включать: параметры соединения с базой данных, подключение библиотеки взаимодействия с JWT -- jsonwebtoken  \cite{npm-jsonwebtoken}, средств генерации ключей и непосредственно секретного ключа -- уникального значения, доступного только серверной части приложения.
На рисунке \ref{code-api-setup-basic} отображен участок кода, отвечающий за проведение этих действий.

\addimghere{images/code/code-api-setup-basic.png}{0.6}{Объявление базовых переменных для построения процесса аутентификации и взаимодействия с базой данных}{code-api-setup-basic}

Следующий этап -- подключение и настройка функционала непосредственной аутентификации пользователя.
За эту задачу будет отвечать библиотека passport \cite{npm-passport}, способная выполнять операции подтверждения действий различными методами.
В нашем случае потребуется задействовать функционал взаимодействия с JWT -- passport-jwt и его составляющие по извлечению из запроса, а также описание стратегии взаимодействия с полученным запросом.
На рисунке \ref{code-api-setup-passport} отображен участок кода, отвечающий за проведение этих действий.

\addimghere{images/code/code-api-setup-passport.png}{0.8}{Объявление переменных взаимодействия с модулем passport, а также его первоначальная настройка}{code-api-setup-passport}

После проведения первоначальных этапов настройки можно перейти к описанию основных этапов аутентификации.
Сюда входит функционал взаимодействия с учетной записью -- вход и выход, а также генерация новых JWT-токенов.

Здесь важно отметить особенности работы такой системы аутентификации.
JWT-токен является краткосрочным, ввиду того, что его можно подделать с помощью обычного копирования из памяти браузера.
Он задействуется в процессе подписи запросов к данным.
В паре с JWT будет задействован еще один токен -- refreshToken, обладающий некоторыми отличиями.
Во-первых, он будет содержаться в базе данных вместе с данными пользователя и, как связанная характеристика, предполагает долгосрочное хранение.
Во-вторых, в его основе будет лежать случайная символьная строка.
В-третьих, refreshToken будет являться основой для генерации JWT-токена.
На рисунке \ref{code-api-login} отображен участок кода, отвечающий за операцию входа пользователя.

\addimghere{images/code/code-api-login.png}{1}{Процесс аутентификации пользователя в серверной части веб-сервиса}{code-api-login}

Здесь важно отметить двойное обращение к базе данных (обозначение строк 84 и 99 на рисунке \ref{code-api-login}).
Задача первого запроса -- найти пользователя с переданными данными для входа.
В случае обнаружения такой записи включается процесс генерации пары токенов (обозначение строк 93 и 96 на рисунке \ref{code-api-login}) с использованием как секретного ключа, так и случайно сгенерированной строки.
Далее производится обновление записи найденного пользователя с новым значением refreshToken.

На рисунке \ref{code-api-logout} отображен участок кода, отвечающий за операцию выхода пользователя из учетной записи.

\addimghere{images/code/code-api-logout.png}{1}{Процесс выхода пользователя из учетной записи в серверной части веб-сервиса}{code-api-logout}

К системе, ограничивающей доступ в зависимости от прохождения пользователем процесса аутентификации можно отнести показынные на рисунках \ref{code-api-login} и \ref{code-api-logout} обработчики входа и выхода пользователя, а также еще один -- обновления JWT-токена, показанный на рисунке \ref{code-api-refresh}.

Для того, чтобы задействовать новый функционал можно обратить внимание на ранее приведенный участок кода, связанный с обработкой POST операции к таблице <<Courses>> на рисунке \ref{code-api-example-courses-3}.

\addimghere{images/code/code-api-refresh.png}{1}{Процесс обновления JWT-токена в серверной части веб-сервиса}{code-api-refresh}

Модификация приведенного участка кода будет достаточно проста -- требуется добавить в передаваемых параметрах функции post обращение к модулю passport с запросом аутентификации по стратегии JWT.
Пример исполнения такой доработки отображен на рисунке \ref{code-api-courses-post-auth}.

\addimghere{images/code/code-api-courses-post-auth.png}{1}{Процесс обновления JWT-токена в серверной части веб-сервиса}{code-api-courses-post-auth}

Как видно по участку кода (обозначение строки 186 на рисунке \ref{code-api-login}), добавленное обращение <<passport.authenticate('jwt')>> будет задействоваться при попытке выполнения метода POST к таблице <<Courses>>.
Если пользователь не будет аутентифицирован, то выполнение данной операции станет недоступным.

Аналогичным образом можно модифицировать и другие обращения к программным интерфейсам веб-сервиса с целью изменения.


\subsection{Взаимодействие бизнес-логики клиентской части с программными интерфейсами серверной части веб-ресурса}

Помимо настройки программных интерфейсов на стороне сервера, необходимо <<обучить>> взаимодействию с ней клиентскую часть веб-приложения.
Для этого потребуется перейти к возможностям Angular.

Важной особенностью клиентской стороны приложения на базе Angular является возможность разбиения приложения на составные части -- компоненты.
Каждый компонент исполняет свою задачу и содержит собственный набор файлов, в который входят HTML-шаблон, SCSS/CSS-документ стилей, TypeScript-документ с описанием логики компонента, из которых формируется отдельный элемент веб-приложения, который можно задействовать как самостоятельную страницу, так и часть другой.
Пример реализации компонента страницы <<Courses>> отображен на рисунке \ref{code-front-courses-ts}.

\addimghere{images/code/code-front-courses-ts.png}{0.9}{Описание компонента <<Courses>> для страницы с имеющимися курсами}{code-front-courses-ts}

Здесь важно отметить способ получения данных компонентом, находящийся на строках 19 -- 22 рисунка \ref{code-front-courses-ts}.
В данном случае задействуется еще один из функциональных элементов Angular -- созданный сервис <<CourseService>>.
В его составе находится участок кода, отображенный на рисунке \ref{code-front-course-service-getall}.

\addimghere{images/code/code-front-course-service-getall.png}{0.6}{Участок кода сервиса <<CourseService>>}{code-front-course-service-getall}

В данном случае производится перенаправление обращения к другому сервису -- <<WebRequestService>>, выполняющему обработку обращений к программным интерфейсам.
В его составе вызываемая функция get отображенная на рисунке \ref{code-front-webrequest-service-get}.

\addimghere{images/code/code-front-webrequest-service-get.png}{0.6}{Функция get сервиса <<WebRequestService>>}{code-front-webrequest-service-get}

Из приведенного на изображении \ref{code-front-webrequest-service-get} кода, в конечном итоге производится обращение к встроенному в Angular сервису HttpClient для обработки HTTP запросов.
Здесь передается запрашиваемый URL и исполняется GET-запрос к серверной стороне приложения, описание которой приведено выше.

На рисунке \ref{code-front-courses-scss} отображено содержимое SCSS файла настройки стилей компонента <<Courses>>.

\addimghere{images/code/code-front-courses-scss.png}{0.6}{Описание компонента <<Courses>> для страницы с имеющимися курсами}{code-front-courses-scss}

Сам шаблон может обозначаться как неполная HTML страница, а также включать обращения к частям TypeScript-документа, содержащего логику компонента.
На рисунке \ref{code-front-courses-html} отображено содержимое HTML файла настройки шаблона компонента <<Courses>>.

\addimghere{images/code/code-front-courses-html.png}{1}{Описание компонента <<Courses>> для страницы с имеющимися курсами}{code-front-courses-html}

Например, строка 47 рисунка \ref{code-front-courses-html} описывает стандартный HTML-элемент кнопки с включением в него возможностей от Angular -- описания событий и действий к ним привязанным.

В процессе аутентификации в приложении с клиентской стороны участвуют несколько элементов, построенных на основе Angular.
Например, в веб-сервисе задействуются средства <<защитников>> -- guard.
Это специальный модуль приложения, который принимает решение о предоставлении доступа к некоторому содержимому.
В состав веб-ресурса внесены два таких элемента -- ContentEditorGuard и AuthGuard, контролирующие доступ к странице редактирования контента.

Помимо <<защитников>> используются также interceptors -- инструменты для перехвата производимых операции, например TokenInterceptor выполняет задачи добавления токена аутентификации для отправляемых запросов, а также обрабатывающий связанные с этим процессом ошибки.

Одним из самых значимых компонентов исполнения процесса авторизации является сервис AuthService.
Он построен на базе класса, предлагаемого Angular.
В задачи AuthService входит обработка операций, связанных с аутентификацией пользователя -- вход, выход, подтверждение аутентифицированного состояния, получение и хранение JWT-токенов.

На этом обзор доработок системы аутентификации и программных интерфейсов веб-ресурса можно завершить.
На очереди рассмотрение интерфейсной части приложения.

\clearpage
